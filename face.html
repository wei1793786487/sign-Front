<!doctype html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>签到界面</title>
    <link rel="stylesheet" type="text/css" href="./css/default.css">
    <link rel="stylesheet" type="text/css" href="./css/styles.css">
    <link rel="stylesheet" type="text/css" href="./css/style.css">


    <script src="./lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
    <script src="./lib/face_js/tracking-min.js"></script>
    <script src="./lib/face_js/face-min.js"></script>
    <script src="./js/"></script>


    <style>
        * {
            padding: 0;
            margin: 0;
        }

        .container {
            position: relative;
            width: 250px;
            height: 150px;
            float: left;
            margin-left: 30px;
            margin-top: 20px;
        }

        .message {
            float: left;
            position: relative;
            top: 30px;
            left: 30px;
        }

        video,
        #canvas {
            position: absolute;
            width: 260px;
            height: 190px;
        }
    </style>
    <script>
        function getParameter(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
            var r = location.search.substr(1).match(reg);
            if (r != null) return (r[2]);
            return null;
        }


        $(function () {
            var video = document.getElementById('video');
            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');
            var shortCut = document.getElementById('shortCut');
            var scContext = shortCut.getContext('2d');
            var time = 2000; //向后台发照片的冷却时间

            var tracker = new tracking.ObjectTracker('face');
            tracker.setInitialScale(4);
            tracker.setStepSize(2);
            tracker.setEdgesDensity(0.1);

            tracking.track('#video', tracker, {
                camera: true
            });
            var flag = true;
            tracker.on('track', function (event) {
                if (event.data.length === 0) {
                    context.clearRect(0, 0, canvas.width, canvas.height);
                } else {
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    event.data.forEach(function (rect) {
                        context.strokeStyle = '#ff0000';
                        context.strokeRect(rect.x, rect.y, rect.width, rect.height);
                        context.fillStyle = "#ff0000";
                        //console.log(rect.x, rect.width, rect.y, rect.height);
                    });
                    if (flag) {
                        console.log("拍照");
                        getPhoto();
                        flag = false;
                        setTimeout(function () {
                            flag = true;
                        }, time);
                    } else {
                        //console.log("冷却中");
                    }
                }
            });


            //将消息显示在网页上 
            function setMessageInnerHTML(innerHTML) {
                document.getElementById('checkinMsg').innerHTML = innerHTML;
            }

            var mid = getParameter("mid");

            function getPhoto() {
                scContext.drawImage(video, 0, 0, 290, 218);
                var imgStr = shortCut.toDataURL("image/png");

                $.ajax({
                    url: "http://api.wukaka.com/face/search",
                    type: "post",
                    dataType: "json",
                    data: {
                        imgStr: imgStr.substring(imgStr.indexOf(",") + 1),
                        mid: mid
                    },
                    success: function (data) {
                        console.log(data);

                        if (data.code === 200) {
                          var success=  data.data;
                          alert(success)
                          setMessageInnerHTML(success)
                        } else {
                            alert(data.message)

                            setMessageInnerHTML(data.message);

                        }
                    }
                })

            }







        });
    </script>
</head>

<body>
    <div id="bg">
        <canvas></canvas>
        <canvas></canvas>
        <canvas></canvas>
    </div>
    <div class='login'>

        <div class='login_title'>
            <span style="text-align: center;display:block;">签到界面</span>
        </div>
        <div class='login_fields'>
            <div class="container">
                <video id="video" preload autoplay loop muted></video>
                <canvas id="canvas"></canvas>
                <div id="checkinMsg" style="color: white"></div>

            </div>
            <div class="message" style="display:none;">
                <canvas id="shortCut" width="500" height="500"></canvas>
            </div>


        </div>

        <div class='disclaimer'>



        </div>

    </div>


    <script src="./lib/face_js/canva_moving_effect.js"></script>
</body>

</html>