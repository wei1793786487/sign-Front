<!doctype html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>企业资源与教育优化一体化管理平台</title>
	<link rel="stylesheet" type="text/css" href="./css/default.css">
	<link rel="stylesheet" type="text/css" href="./css/styles.css">
	<link rel="stylesheet" type="text/css" href="./css/style.css">


	<script src="./lib/jquery-3.4.1/jquery-3.4.1.min.js"></script>
	<script src="./lib/face_js/tracking-min.js"></script>
    <script src="./lib/face_js/face-min.js"></script>
    <style>
        * {
            padding: 0;
            margin: 0;
        }
 
        .container {
            position: relative;
            width: 250px;
            height: 150px;
            float:left;
            margin-left: 30px;
            margin-top: 20px;
        }
        .message{
        	float:left;
			position: relative;
			top: 30px;
			left: 30px;
        }
        video, #canvas {
            position: absolute;
            width: 260px;
            height: 190px;
        }
 
    </style>
	    <script>
	    $(function () {
	        var video = document.getElementById('video');
	        var canvas = document.getElementById('canvas');
	        var context = canvas.getContext('2d');
	        var shortCut = document.getElementById('shortCut');
	        var scContext = shortCut.getContext('2d');
			var time =1000;//向后台发照片的冷却时间
			
	        var tracker = new tracking.ObjectTracker('face');
	        tracker.setInitialScale(4);
	        tracker.setStepSize(2);
	        tracker.setEdgesDensity(0.1);
	
	        tracking.track('#video', tracker, {camera: true});
			var flag=true;
	        tracker.on('track', function (event) {
	        	if (event.data.length === 0) {
	        		context.clearRect(0, 0, canvas.width, canvas.height);
	        	}else{
	        		context.clearRect(0, 0, canvas.width, canvas.height);
	        		event.data.forEach(function (rect) {
		                context.strokeStyle = '#ff0000';
		                context.strokeRect(rect.x, rect.y, rect.width, rect.height);
		                context.fillStyle = "#ff0000";
		                //console.log(rect.x, rect.width, rect.y, rect.height);
		            });
	        		if(flag){
	        			console.log("拍照");
	        			getPhoto();
	        			flag=false;
	        			setTimeout(function(){flag=true;},time);
	        		}else{
	        			//console.log("冷却中");
	        		}
	        	}
	        });
	        
	        function getPhoto() {
	        	scContext.drawImage(video,0,0,290,218);
	        	var imgStr = shortCut.toDataURL("image/png");
	        	
	        	//讲拍照的图片数据发送到controller，调用百度云，签到，返回签到结果
	        	$.ajax({
	        		url:"identifyUser",
	        		type:"post",
	        		dataType:"json",
	        		data:{
	        			imgStr:imgStr.substring(imgStr.indexOf(",")+1)
	        		},
	        		success:function(result){
	        			if(result.result == "true"){
	        				if(result.user != "404"){
		        				send("user_info:"+result.user);
	        				}
	        			}
	    	        	
	        		}
	        	})
	        	
	        }
	    

	    		setMessageInnerHTML("弄好哒哒哒"); 

	  
	    	//将消息显示在网页上 
	    	function setMessageInnerHTML(innerHTML) { 
	    		document.getElementById('checkinMsg').innerHTML = innerHTML ; 
	    	} 
	    
	    	
	    });
	
	</script>
</head>
<body>
<div id="bg">
		<canvas></canvas>
		<canvas></canvas>
		<canvas></canvas>
	</div>
	<div class='login'>
	  
	  <div class='login_title' >
	    <span style="text-align: center;display:block;">用户登录</span>
	  </div>
	  <div class='login_fields'>
	    <div class="container">
	    <video id="video" preload autoplay loop muted></video>
	    <canvas id="canvas"></canvas>
	</div>
	<div class="message">
		<canvas id="shortCut" width="0" height="0" ></canvas>
		<div id="checkinMsg" style="color: white"></div>
	</div>
	  </div>
	
	  <div class='disclaimer'>



	  </div>
	
	</div>


	<script src="./lib/face_js/canva_moving_effect.js"></script>
</body>
</html>